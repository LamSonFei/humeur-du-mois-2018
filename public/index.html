<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Welcome to Firebase Hosting</title>

  <script src="https://cdn.auth0.com/js/auth0/9.3.3/auth0.min.js"></script>

  <!-- update the version number as needed -->
  <script defer src="/__/firebase/4.11.0/firebase-app.js"></script>
  <!-- include only the Firebase features as you need -->
  <script defer src="/__/firebase/4.11.0/firebase-auth.js"></script>
  <!-- <script defer src="/__/firebase/4.11.0/firebase-database.js"></script> -->
  <!-- <script defer src="/__/firebase/4.11.0/firebase-messaging.js"></script> -->
  <!-- <script defer src="/__/firebase/4.11.0/firebase-storage.js"></script> -->
  <script defer src="/__/firebase/4.11.0/firebase-firestore.js"></script>
  <!-- initialize the SDK after all desired features are loaded -->
  <script defer src="/__/firebase/init.js"></script>

  <style media="screen">
    body {
      background: #ECEFF1;
      color: rgba(0, 0, 0, 0.87);
      font-family: Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    #message {
      background: white;
      max-width: 360px;
      margin: 100px auto 16px;
      padding: 32px 24px;
      border-radius: 3px;
    }

    #message h2 {
      color: #ffa100;
      font-weight: bold;
      font-size: 16px;
      margin: 0 0 8px;
    }

    #message h1 {
      font-size: 22px;
      font-weight: 300;
      color: rgba(0, 0, 0, 0.6);
      margin: 0 0 16px;
    }

    #message p {
      line-height: 140%;
      margin: 16px 0 24px;
      font-size: 14px;
    }

    #message button {
      display: block;
      width: 100%;
      text-align: center;
      background: #039be5;
      text-transform: uppercase;
      text-decoration: none;
      color: white;
      margin: 8px;
      padding: 16px;
      border-radius: 4px;
    }

    #message,
    #message button {
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
    }

    @media (max-width: 600px) {
      body,
      #message {
        margin-top: 0;
        background: white;
        box-shadow: none;
      }
      body {
        border-top: 16px solid #ffa100;
      }
    }
  </style>
</head>

<body>
  <div id="message">
    <h2>Welcome</h2>
    <h1>What has this month been like for you at Zenika?</h1>
    <button type="button" id="loginButton">Log in</button>
    <button type="button" id="submitGreat">Great!</button>
    <button type="button" id="submitNotThatGreat">Not that great</button>
    <button type="button" id="submitNotGreatAtAll">Not great at all</button>
  </div>

  <script>
    window.addEventListener('load', function () {

      var webAuth = new auth0.WebAuth({
        domain: 'zenika.eu.auth0.com',
        clientID: 'j5xIoOh3R9Jov6wtKQm2BAHUSkrYpttY',
        responseType: 'token id_token',
        audience: 'https://zenika.eu.auth0.com/userinfo',
        scope: 'openid email',
        redirectUri: window.location.href
      });

      loginButton.addEventListener('click', function (e) {
        e.preventDefault();
        webAuth.authorize();
      });

      handleAuthentication();

      function handleAuthentication() {
        webAuth.parseHash(function (err, authResult) {
          console.log(err, authResult)
          if (authResult && authResult.accessToken && authResult.idToken) {
            window.location.hash = '';
            setSession(authResult);
          } else if (err) {
            console.log(err);
            alert(
              'Error: ' + err.error + '. Check the console for further details.'
            );
          }
          const user = JSON.parse(localStorage.getItem('user'))
          const accessToken = localStorage.getItem('access_token')
          fetch(/*"https://us-central1-humeur-du-mois-2018.cloudfunctions.net/exchangeToken"*/ "http://localhost:5001/humeur-du-mois-2018/us-central1/exchangeToken", {
            method: 'POST',
            body: JSON.stringify({ userId: user.sub, accessToken: accessToken }),
            headers: { 'Content-Type': 'application/json' }
          })
            .then(response => response.text())
            .then(firebaseToken => {
              firebase.auth().signInWithCustomToken(firebaseToken).catch((error) => {
                console.log(error)
              });
            })
          displayButtons();
        });
      }

      function setSession(authResult) {
        // Set the time that the Access Token will expire at
        var expiresAt = JSON.stringify(
          authResult.expiresIn * 1000 + new Date().getTime()
        );
        localStorage.setItem('access_token', authResult.accessToken);
        localStorage.setItem('id_token', authResult.idToken);
        localStorage.setItem('expires_at', expiresAt);
        webAuth.client.userInfo(authResult.accessToken, function (err, user) {
          localStorage.setItem('user', JSON.stringify(user))
        });
      }

      function logout() {
        // Remove tokens and expiry time from localStorage
        localStorage.removeItem('access_token');
        localStorage.removeItem('id_token');
        localStorage.removeItem('expires_at');
        displayButtons();
      }

      function isAuthenticated() {
        // Check whether the current time is past the
        // Access Token's expiry time
        var expiresAt = JSON.parse(localStorage.getItem('expires_at'));
        return new Date().getTime() < expiresAt;
      }

      function displayButtons() {
        if (isAuthenticated()) {
          loginButton.style.display = 'none';
          // logoutBtn.style.display = 'inline-block';
          // loginStatus.innerHTML = 'You are logged in!';
        } else {
          loginButton.style.display = 'inline-block';
          // logoutBtn.style.display = 'none';
          // loginStatus.innerHTML =
          // 'You are not logged in! Please log in to continue.';
        }
        enableFirestore()
      }
    });

    function getUser() {
      return JSON.parse(localStorage.getItem('user'))
    }

    function enableFirestore() {
      // // ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥
      // // The Firebase SDK is initialized and available here!
      //
      // firebase.auth().onAuthStateChanged(user => { });
      // firebase.database().ref('/path/to/ref').on('value', snapshot => { });
      // firebase.messaging().requestPermission().then(() => { });
      // firebase.storage().ref('/path/to/ref').getDownloadURL().then(() => { });
      //
      // // ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥

      var db = firebase.firestore();

      const saveResponse = response => {
        db.collection("responses").add({
          respondant: getUser().email,
          response: response,
          instant: new Date().toISOString()
        })
      }

      submitGreat.onclick = () => saveResponse('great')
      submitNotThatGreat.onclick = () => saveResponse('notThatGreat')
      submitNotGreatAtAll.onclick = () => saveResponse('notGreatAtAll')
    }
  </script>
</body>

</html>